<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      html {
        font-family: system-ui, -apple-system, sans-serif;
      }
      main {
        height: 100vh;
        width: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background: rgb(71, 147, 218);
      }

      #lista {
        display: flex;
        list-style: none;
      }

      .tubo + .tubo {
        margin-left: 1rem;
      }

      .tubo {
        border: 0.4rem solid;
        border-color: rgb(255, 255, 255);
        width: 4rem;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        border-bottom-left-radius: 2rem;
        border-bottom-right-radius: 2rem;
        border-top-width: 0;
        overflow: hidden;
        cursor: pointer;
        position: relative;
      }

      .tubo::after {
        content: "";
        display: flex;
        height: calc(100% - 0.5rem);
        width: 100%;
        background: rgba(255, 255, 255, 20%);
        position: absolute;
      }
      .tubo::before {
        content: "";
        display: flex;
        height: 1rem;
        width: 8rem;
        z-index: 1;
        top: 50%;
        left: -50%;
        rotate: -45deg;
        background: rgba(255, 255, 255, 30%);
        position: absolute;
      }

      .selecionado {
        border-color: rgb(255, 0, 0);
      }

      .conteudo {
        height: 3rem;
        width: 100%;
      }
      #mensagem {
        font-size: 2rem;
        color: white;
        margin-bottom: 1.5rem;
      }
    </style>
  </head>
  <body>
    <main>
      <p id="mensagem"></p>
      <ul id="lista"></ul>
    </main>
    <script>
      const QUANTIDADE_POR_TUBO = 4;
      const ALTURA_POR_CONTEUDO = 3;
      const COLORS = {
        amarelo: "#f5b942",
        azul: "#4272f5",
        verde: "#42f551",
        vermelho: "#f54260",
      };
      Object.freeze(COLORS);

      let tuboSelecionado = null;
      let tubos = [
        [COLORS.amarelo, COLORS.verde, COLORS.vermelho, COLORS.azul],
        [COLORS.amarelo, COLORS.azul, COLORS.vermelho, COLORS.verde],
        [COLORS.azul, COLORS.amarelo, COLORS.vermelho, COLORS.verde],
        [],
      ];

      const getPrimeirosItensDoTubo = (tempTubo, limit, itens = []) => {
        let tubo = [...tempTubo];
        const cor = tubo[0];
        const semItens = !tubo.length;
        const corDiferente = itens.length && !itens.includes(cor);
        const atingiuLimite = limit && itens.length === limit;
        if (atingiuLimite || semItens || corDiferente) return [itens, tubo];

        tubo.shift();
        itens.push(cor);
        return getPrimeirosItensDoTubo(tubo, limit, itens);
      };

      const verificarTubos = () => {
        const ganhou = tubos.reduce((resultado, tubo) => {
          const todosIguais = tubo.every((cor) => cor === tubo[0]);
          return resultado && todosIguais;
        }, true);

        if (ganhou) {
          const texto = document.getElementById("mensagem");
          texto.innerHTML = "Venceu!";
        }
      };

      const onClicarTubo = (tubo, index) => {
        if (tuboSelecionado === null) {
          tuboSelecionado = { index, tubo };
        } else {
          if (tubo.length < QUANTIDADE_POR_TUBO) {
            const limite = QUANTIDADE_POR_TUBO - tubo.length;
            const [coresParaAdd, newTubo] = getPrimeirosItensDoTubo(
              tuboSelecionado.tubo,
              limite
            );
            tubos[tuboSelecionado.index] = [...newTubo];
            tubos[index] = [...coresParaAdd, ...tubos[index]];
            verificarTubos();
          }
          tuboSelecionado = null;
        }

        showTubos();
      };

      const showTubos = () => {
        const listaElement = document.getElementById("lista");
        listaElement.innerHTML = "";
        tubos.forEach((tubo, index) => {
          const tuboElemento = document.createElement("li");
          tuboElemento.style.height =
            QUANTIDADE_POR_TUBO * ALTURA_POR_CONTEUDO + 1 + ".5rem";
          tuboElemento.onclick = () => onClicarTubo(tubo, index);
          const isSelecionado = tuboSelecionado?.index === index;
          tuboElemento.className = `tubo ${isSelecionado ? "selecionado" : ""}`;
          tubo.forEach((cor) => {
            const conteudo = document.createElement("div");
            conteudo.style.background = cor;
            conteudo.className = "conteudo";
            tuboElemento.appendChild(conteudo);
          });
          listaElement.appendChild(tuboElemento);
        });
      };
      showTubos();
    </script>
  </body>
</html>
